# 웹 보안 실습 - 2025년 8월 26일 작업 기록

## 주요 작업 내용

### 1. 프로젝트 실행 및 초기화
- Docker 환경에서 웹 보안 실습 플랫폼 실행
- 초기 데이터베이스 설정 문제 해결
- `docker compose down -v` → `docker compose up -d`로 데이터베이스 초기화

### 2. 디렉토리 트레버셜(LFI) 취약점 분석
- **취약점 위치:** `/web/file_viewer.php:207-213`
- **문제점:** 디렉토리 트레버셜 방어 코드가 주석 처리되어 비활성화됨
- **공격 예시:** `file_viewer.php?file=../../../etc/passwd`

### 3. LFI 보안 토글 시스템 구현

#### 3.1 security.php 업데이트
```php
// LFI 보안 설정 추가
'lfi_protection' => isset($_POST['lfi']) ? true : false
```
- 새로운 "파일 뷰어 페이지 설정" 섹션 추가
- LFI 대책 토글 스위치 구현
- 모든 보안 설정(전체 ON/OFF, 권장 설정)에 LFI 보안 포함

#### 3.2 file_viewer.php 업데이트
```php
// 보안 설정 확인
$lfi_protection = isset($_SESSION['security_settings']['lfi_protection']) ? $_SESSION['security_settings']['lfi_protection'] : false;

// 디렉토리 트레버셜 대책 (보안 설정에 따라 토글)
if ($lfi_protection && strpos($file_path, '..') !== false) {
    echo '<div class="error-message">🚫 보안 경고: 디렉토리 트레버셜 시도가 감지되어 차단되었습니다.</div>';
}
```
- 세션 기반 보안 설정 확인
- 현재 LFI 보안 상태를 UI에 표시
- 토글 상태에 따른 동적 보안 제어

### 4. RFI 취약점 테스트 환경 구성

#### 4.1 PHP 설정 변경
```ini
# php.ini 생성
allow_url_include = On
allow_url_fopen = On
```
- Dockerfile 수정하여 커스텀 php.ini 적용
- Docker 이미지 재빌드 및 컨테이너 재시작

#### 4.2 RFI 공격 테스트
- **로컬 RFI:** `http://localhost/uploads/shell.phtml&cmd=pwd` ✅ 성공
- **원격 RFI:** GitHub raw URL 테스트 (확장자 문제로 실패)
- **문제 원인:** `.php` 확장자가 허용된 텍스트 파일로 인식됨

### 5. RFI 보안 대책 구현

#### 5.1 URL 패턴 차단 방식 선택
- 가장 일반적이고 효과적인 방법 채택
- `preg_match('/^(https?|ftp):\/\//i', $file_path)` 패턴 사용

#### 5.2 security.php에 RFI 설정 추가
```php
'rfi_protection' => isset($_POST['rfi']) ? true : false
```
- RFI 전용 토글 스위치 추가
- 모든 보안 설정 액션에 RFI 보안 통합

#### 5.3 file_viewer.php에 RFI 차단 로직 구현
```php
// RFI 대책 (보안 설정에 따라 토글)
if ($rfi_protection && preg_match('/^(https?|ftp):\/\//i', $file_path)) {
    echo '<div class="error-message">🚫 보안 경고: 원격 파일 포함(RFI) 시도가 감지되어 차단되었습니다.</div>';
}
```
- URL 프로토콜 패턴 감지
- LFI와 RFI 보안 상태 동시 표시
- 우선순위: RFI → LFI → 정상 처리

## 보안 기능 현황

### 구현된 보안 제어
1. **XSS 대책 (2개)**
   - 응답 인코딩
   - 출력 필터링

2. **CSRF 대책 (2개)**
   - 토큰 생성
   - 토큰 검증

3. **SQL Injection 대책 (2개)**
   - 게시글 상세보기 보안
   - 검색 기능 보안

4. **파일 업로드 보안**
   - MIME 타입 검증

5. **LFI 대책** ⭐ 새로 추가
   - 디렉토리 트레버셜 차단

6. **RFI 대책** ⭐ 새로 추가
   - URL 패턴 차단

### 보안 제어 방식
- **중앙 집중식 관리:** `security.php`에서 모든 보안 설정 통합
- **세션 기반 저장:** 사용자별 독립적인 보안 설정
- **실시간 토글:** 즉시 적용되는 보안 제어
- **시각적 피드백:** UI에서 현재 보안 상태 표시

## 테스트 결과

### LFI 테스트
- **보안 OFF:** `file_viewer.php?file=../../../etc/passwd` 접근 가능
- **보안 ON:** 디렉토리 트레버셜 차단 메시지 표시

### RFI 테스트  
- **보안 OFF:** `file_viewer.php?file=http://localhost/uploads/shell.phtml&cmd=pwd` 실행 가능
- **보안 ON:** 원격 파일 포함 차단 메시지 표시

## 향후 개선 과제

1. **화이트리스트 방식 추가**
   - 허용된 디렉토리만 접근 가능하도록 제한

2. **로그 시스템 구현**
   - 공격 시도 기록 및 모니터링

3. **추가 RFI 차단 패턴**
   - data://, file://, php:// 등 다른 프로토콜 차단

4. **보안 설정 영속화**
   - 데이터베이스 또는 파일 기반 설정 저장

## 파일 변경 이력

### 수정된 파일
- `security.php` - RFI 보안 설정 추가
- `file_viewer.php` - LFI/RFI 차단 로직 구현
- `Dockerfile` - 커스텀 php.ini 적용
- `php.ini` - allow_url_include 활성화 (새로 생성)

### 생성된 파일
- `uploads/shell.phtml` - RFI 테스트용 파일
- `uploads/phpinfo.php` - PHP 설정 확인용

## 기술 스택
- **Backend:** PHP 7.4, MySQL 5.7
- **Frontend:** HTML, CSS, JavaScript
- **Infrastructure:** Docker, Apache
- **Security:** Session-based security controls

---
*작업 완료일: 2025년 8월 26일*